---
title: 'A Systemic Review of Phenotypic Antimicrobial Resistance in Non-Typhoidal Salmonella (NTS) Isolated from Food Animals in Africa'
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  html_document: default
  pdf_document: default
keep_md: yes
---

```
# A Systemic Review of Phenotypic Antimicrobial Resistance in Non-Typhoidal Salmonella (NTS) Isolated from Food Animals in Africa

An R-based analysis of antimicrobial resistance patterns in non-typhoidal Salmonella from food animals across Africa.

This R Markdown document implements numerical procedures for analyzing antimicrobial resistance (AMR) data in non-typhoidal Salmonella isolated from food animals in Africa. The analysis covers various aspects of AMR patterns and trends.

The analysis allows for five different types of analyses:

* **Map of studies**: A geospatial visualization showing the number of studies covered in each African country.

* **Temporal trends analysis**: Plots showing temporal trends in antimicrobial resistance, both overall and by region. This includes generalized linear model analysis, diagnostic plots and statistical tests.

* **Regional resistance patterns**: Analysis of resistance levels of antibiotic compounds aggregated by species at the regional level.

* **Antibiotic class resistance**: Examination of median resistance of antibiotic classes aggregated by species.



The analysis uses several R packages for data manipulation, visualization, and statistical analysis, including tidyverse, ggplot2, and various mapping libraries.

## Getting Started

[Include instructions on how to set up the environment, install necessary packages, and run the analysis]

## Data
All the datasets used are created from the dataset named AMR_clean.csv in the data folder.
SalMeandf.csv is created from AMR_clean.csv for analysis of temporal trends.



## Analysis Modules


### 1. Map of Studies

This section generates a map showing the number of studies covered in each African country. The process involves:

- Loading and preprocessing the AMR data
- Using the `rnaturalearth` package to create a base map of Africa
- Aggregating the number of studies per country
- Visualizing the data using `tmap` to create a choropleth map
- The resulting map uses a color gradient to represent the number of studies in each country, with a legend explaining the color scale

### 2. Temporal Trends Analysis

This analysis examines how antimicrobial resistance has changed over time. The process includes:

- Aggregating resistance data by year, country, and region
- Fitting generalized linear models (GLMs) to assess trends over time
- Creating plots showing overall and regional trends in resistance over the years
- Using boxplots to show the distribution of resistance levels for each year
- Applying statistical tests (Fisher's exact test) to assess the significance of temporal trends
- The results are visualized using ggplot2, with separate plots for overall trends and regional trends (East, West, North, and South Africa)
-we  also generate diagnostic plots to assess the model fit and assumptions using boot package
-we also calculated QAIC using the formula QAIC = -2*logLikelihood + 2*k, where k is the number of parameters in the model

### 3. Regional Resistance Patterns

This section analyzes how resistance patterns vary across different regions of Africa:

- Aggregating resistance data by antibiotic compound, species, and region
- Creating bar plots to show resistance levels for different antibiotic compounds in each region
- Using ggplot2 to generate separate plots for East, West, North, and Southern Africa
- Each plot shows resistance levels for various antibiotic compounds, with different colors representing different animal species
- Error bars are included to show the confidence intervals for the resistance estimates

### 4. Antibiotic Class Resistance

This analysis focuses on resistance patterns across broader antibiotic classes:

- Grouping individual antibiotics into larger classes (e.g., Tetracyclines, Penicillins, Cephalosporins)
- Calculating median resistance levels for each antibiotic class across different animal species
- Creating box plots to visualize the distribution of resistance levels for each antibiotic class
- Separate plots are generated for each major antibiotic class (Tetracyclines, Penicillins, Cephalosporins, Aminoglycosides, Fluoroquinolones, Sulfonamides)
- The plots allow for comparison of resistance levels across different animal species within each antibiotic class



## References

1. Crawley, Michael J. (2013). The R book. Chichester, West Sussex, United Kingdom :Wiley,

2.Moraga, Paula. (2023). Spatial Statistics for Data Science: Theory and Practice with R. Chapman & Hall/CRC Data Science Series

3. Schweinberger, Martin. 2022. Fixed- and Mixed-Effects Regression Models in R. Brisbane: The University of Queensland. url: https://slcladal.github.io/regression.html (Version 2022.09.14).




```




```{r load-packages, include=FALSE}
library(tidyverse)
library(tmap)
library(leaflet) 
library(sf) 
library(RColorBrewer)
library(htmltools) 
library(leafsync) 
library(rnaturalearth)
library(viridis)
library(mapview)
library(ggpubr)
library(boot)#diagnostic plots
library(lme4)##glm
library(ggplot2)
library(janitor)
library(patchwork)
library(grid)
library(gridExtra)
library(wesanderson)
library(RColorBrewer)
library(ggsci)
sf_use_s2(FALSE)
```


```{r setup, include=FALSE}
#knitr::opts_chunk$set(echo = TRUE,
                   # echo = FALSE,
                    #cache = TRUE)
```


```{r PlotTheme, include = FALSE, echo = FALSE}
  
theme_Publication <- function(base_size=14, base_family="helvetica") {
  library(grid)
  library(ggthemes)
  (theme_foundation(base_size=base_size, base_family=base_family)
    + theme(plot.title = element_text(face = "bold",
                                      size = rel(1.2), hjust = 0.5),
            text = element_text(),
            panel.background = element_rect(colour = NA),
            plot.background = element_rect(colour = NA),
            panel.border = element_rect(colour = NA),
            axis.title = element_text(face = "bold", size = rel(1)),
            axis.title.y = element_text(angle=90, vjust = 2),
            axis.title.x = element_text(vjust = -0.2),
            axis.text = element_text(), 
            axis.line = element_line(colour="black"),
            axis.ticks = element_line(),
            panel.grid.major = element_line(colour="#f0f0f0"),
            panel.grid.minor = element_blank(),
            legend.key = element_rect(colour = NA),
            legend.position = "",
            legend.direction = "horizontal",
            legend.key.size = unit(0.2, "cm"),
            legend.margin = unit(0, "cm"),
            legend.title = element_blank(),  # Remove legend title
            legend.text = element_blank(),   # Optionally, remove legend text
            plot.margin = unit(c(10,5,5,5), "mm"),
            strip.background = element_rect(colour="#f0f0f0", fill="#f0f0f0"),
            strip.text = element_text(face="bold")
    ))
}

scale_fill_Publication <- function(...) {
  library(scales)
  discrete_scale("fill", "Publication", manual_pal(values = c("#386cb0", "#fdb462", "#7fc97f", "#ef3b2c", "#662506", "#a6cee3", "#fb9a99", "#984ea3", "#ffff33")), ...)
}

scale_colour_Publication <- function(...) {
  library(scales)
  discrete_scale("colour", "Publication", manual_pal(values = c("#386cb0", "#fdb462", "#7fc97f", "#ef3b2c", "#662506", "#a6cee3", "#fb9a99", "#984ea3", "#ffff33")), ...)
}





```


### Plot showing map of number of surveys covered in the study

```{r Map of studies, echo=FALSE, fig.height=5, fig.width=7, message=FALSE}
#Load data

sf_use_s2(FALSE) # switch off spherical geometry
#> Spherical geometry (s2) switched off
##loading data

AMR_clean <- read.csv("AMR_clean.csv")

world <- ne_countries(type = 'countries', 
                      scale = 'small', 
                      returnclass = "sf") 


###using map view package to plot world AMR rates
# AMR <- AMR %>%
#   na.omit

df <- AMR_clean %>%
  group_by(country) %>%
  select(country, percent_resistant, x_coordinate, y_coordinate, species) %>%
  set_names(c("country", "percentage_resistance", "long", "lat", "species")) %>%
  filter(!is.na(percentage_resistance)) 


###changing percentage_resistance to numeric class
df$percentage_resistance <- as.numeric(as.character(df$percentage_resistance))

##Summarizing the data
df1 <- df %>%
  group_by(country) 
  # summarise(percentage_resistance = mean(percentage_resistance, na.rm = TRUE))

world_amr1 <- world %>%
  filter(continent == "Africa") %>%
  select(country = sovereignt,iso_a3, geometry) #%>%
 # left_join(df1, by = "country")

##Adding number of studies to the dataset
data1 <- AMR_clean %>% 
  group_by(country, author) %>% 
  filter(row_number()==1) %>% 
  dplyr:: select(country) %>%
  distinct() %>% as.data.frame() # drop duplicates.


data2 <- data1 %>% 
  group_by( country) %>% 
  mutate(no_studies = n()) %>%
  dplyr:: select(country, no_studies) %>%
  distinct() %>% as.data.frame() # drop duplicates.


#Joining the data to add number of studies
world_amr2 <- world_amr1 %>%
  left_join(data2, by = "country")%>%
  unique()

world_amr2 %>%
  mapview(zcol = "no_studies",
          col.regions = viridisLite::plasma) 

# plotting the map
mapplot<-tm_shape(world_amr2) + 
  tm_polygons(col = "no_studies",  
              title = "number of studies",
              palette = "RdYlBu") +
  tm_text("no_studies", size = 0.7) 
mapplot
```

### Plots showing temporal trends (overall trends and regional trends)




```{r Temporal trends analysis, echo=FALSE, fig.height=10, fig.width=15, message=FALSE}
#Mapping AST Methods
AMR_clean<-read.csv("AMR_clean.csv")



AMR_clean<- AMR_clean %>%
  dplyr::mutate(no_isolates_susceptible=no_isolate-no_isolates_resistant)

AMR_clean<- AMR_clean %>% 
  dplyr::select(-no_isolates_intermediate)


AMRdf<- AMR_clean%>%
  dplyr::select(-sampling_start_year)%>%
  dplyr::mutate(Year=sampling_end_year)%>%
dplyr::select(-sampling_end_year)%>%
  dplyr::select(doi,country, region, Year, species,species_2,strain,no_isolates_resistant,
                no_isolates_susceptible,no_isolate,
                antimicrobial, antibiotic_class, ast_method)
  



data1<- AMRdf%>%
 dplyr::group_by(doi,country, region, Year, species,species_2,strain,no_isolates_resistant,
                 no_isolates_susceptible,no_isolate,
                antimicrobial, antibiotic_class, ast_method)%>%
  dplyr::mutate(MeanRes=sum(no_isolates_resistant)/sum(no_isolate))
  

#data1%>%
 # count(MeanRes)%>%
  #View()


data1 <- data1[!is.na(data1$Year), ]



data1 <- data1[data1$MeanRes != 0, ]
# Assuming data1 is your data frame


data1$Year <- as.factor(data1$Year)

data1$Year <- factor(data1$Year)

data1$country <- factor(data1$country)
data1$region <- factor(data1$region)
data1$species <- factor(data1$species)
data1$species_2 <- factor(data1$species_2)
data1$strain <- factor(data1$strain)
data1$antimicrobial <- factor(data1$antimicrobial)
#data1$who_classification <- factor(data1$who_classification)
data1$ast_method <- factor(data1$ast_method)
data1$antibiotic_class<- factor(data1$antibiotic_class)
data1$no_isolates_resistant<- as.numeric(data1$no_isolates_resistant)
data1$no_isolates_susceptible<-as.numeric(data1$no_isolates_susceptible)
#data1$doi <- factor(data1$doi)

#library(lme4)
# Convert doi to numeric index
data1$doi <- as.numeric(as.factor(data1$doi))



data2<- aggregate(MeanRes~Year+doi+antibiotic_class+country+region+species+no_isolate, data=data1, FUN=mean)
# Convert doi to numeric index
data2$doi <- as.numeric(as.factor(data2$doi))


model1 <- glm(cbind(no_isolates_resistant/no_isolate) ~ Year + country + region + species +antimicrobial+strain+
                ast_method+ (1 | doi),
              family = quasibinomial, weights=no_isolate,data = data1)

#summary(model1)

model2<-glm(cbind(no_isolates_resistant/no_isolate) ~ Year + country + region + species +antimicrobial+strain+
              (1 | doi),
            family=quasibinomial, weights=no_isolate, data = data1)
#summary(model2)


model3<-glm(cbind(no_isolates_resistant/no_isolate) ~ Year + country + region + species +antimicrobial+ (1 | doi),
            family=quasibinomial, weights=no_isolate,
            data = data1)
#summary(model3)

model4<-glm(cbind(no_isolates_resistant/no_isolate) ~ Year + country + region + species + (1 | doi),
            family=quasibinomial, weights=no_isolate, data = data1)
#summary(model4)

model5<-glm(cbind(no_isolates_resistant/no_isolate) ~ Year + country + region + (1 | doi),
            family=quasibinomial, weights=no_isolate, data = data1)
#summary(model5)


model6<-glm(cbind(no_isolates_resistant/no_isolate) ~ Year + country + (1 | doi),
            
            family=quasibinomial, weights=no_isolate, data = data1)
#summary(model6)

model7<- glm(cbind(no_isolates_resistant/no_isolate) ~ Year +  (1 | doi),
             
             family=quasibinomial, weights=no_isolate, data = data1)

#model7




##Diagnostics using boot package
diag_plots<-glm.diag.plots(model7, glmdiag = glm.diag(model7), subset = NULL,
               iden = FALSE, labels = NULL, ret = FALSE)
#glm.diag.plots(model3, glmdiag = glm.diag(model3), subset = NULL,
#                            iden = FALSE, labels = NULL, ret = FALSE)
# diag_plots
# png("model7_diagnostics_highres.png", 
#     width = 10, height = 8, 
#     units = "in", 
#     res = 300, 
#     type = "cairo")

# Generate the plot
# glm.diag.plots(model7, glmdiag = glm.diag(model7), subset = NULL,
#                iden = FALSE, labels = NULL, ret = FALSE)
# 
# # Close the device
# dev.off()


data2$Year <- as.numeric(as.character(data2$Year))

model <- glm(MeanRes ~ Year, data = data2, family = quasibinomial, weights = no_isolate)

new_preds <- predict(model, newdata = data.frame(Year = seq(min(data2$Year), max(data2$Year), by = 1)), 
                     type = "response", se.fit = TRUE)


pred_df <- data.frame(
  Year = seq(min(data2$Year), max(data2$Year), by = 1),
  fit = new_preds$fit,
  se.fit = new_preds$se.fit
)



fit1<-predict(model,type = "response", se.fit = T)


df1<-as.data.frame(fit1)

df2<- cbind(data2, df1)

df3<- df2%>%
  mutate(lower = fit - 1.96 * se.fit)%>%
  mutate(upper = fit+ 1.96 * se.fit)

df4<- aggregate(MeanRes~doi+Year+region, data = df3, FUN = mean)


##overal trends
library(ggplot2)

trendplot <- ggplot() +
  geom_point(data = df4, aes(x = Year, y = MeanRes),
             shape = 21, color = "black", alpha = 0.4, size = 3) +
  geom_line(data = pred_df, aes(x = Year, y = fit), color = "blue", linewidth = 1) +
  geom_ribbon(data = pred_df, aes(x = Year, ymin = fit - 1.96*se.fit, ymax = fit + 1.96*se.fit),
              fill = "gray70", alpha = 0.3) +
  geom_boxplot(data = data2, aes(x = Year, y = MeanRes, group = Year),
               outlier.shape = NA, fill = "skyblue", color = "black", alpha = 0.2) +
  theme_Publication() +
  labs(x = "Year", y = "Mean Resistance") + 
  scale_y_continuous(limits = c(0, 1), breaks = seq(0, 1, by = 0.2)) +
  scale_x_continuous(breaks = seq(min(df4$Year), max(df4$Year), by = 2)) +
  theme(axis.text.x = element_text(angle = 60, hjust = 1))

trendplot

# ggsave(filename = "trendplot.tiff",
#        plot = trendplot,
#        device = "tiff",
#        width = 10,
#        height = 8,
#        units = "in",
#        dpi = 700,
#        compression = "lzw")

#regional trends

#east african trends

ea<- df4%>%
  filter(region=="Eastern Africa")

eadata2<- data2%>%
  filter(region=="Eastern Africa")

eamodel <- glm(MeanRes ~ Year, data = eadata2, family = quasibinomial, weights = no_isolate)

eanew_preds <- predict(eamodel, newdata = data.frame(Year = seq(min(eadata2$Year), max(eadata2$Year), by = 1)), 
                     type = "response", se.fit = TRUE)


eapred_df <- data.frame(
  Year = seq(min(eadata2$Year), max(eadata2$Year), by = 1),
  fit = eanew_preds$fit,
  se.fit = eanew_preds$se.fit
)



eafit1<-predict(eamodel,type = "response", se.fit = T)
print(eafit1)

eadf1<-as.data.frame(eafit1)

eadf2<- cbind(eadata2, eadf1)

eadf3<- eadf2%>%
  mutate(lower = fit - 1.96 * se.fit)%>%
  mutate(upper = fit+ 1.96 * se.fit)

eadf4<- aggregate(MeanRes~doi+Year+region, data = eadf3, FUN = mean)


eaplot <- ggplot() +
  geom_point(data = eadf4, aes(x = Year, y = MeanRes),
             shape = 21, color = "black", alpha = 0.4, size = 3) +
  geom_line(data = eapred_df, aes(x = Year, y = fit), color = "blue", linewidth = 1) +
  geom_ribbon(data = eapred_df, aes(x = Year, ymin = fit - 1.96*se.fit, ymax = fit + 1.96*se.fit),
              fill = "gray70", alpha = 0.3) +
  geom_boxplot(data = eadata2, aes(x = Year, y = MeanRes, group = Year),
               outlier.shape = NA, fill = "skyblue", color = "black", alpha = 0.2) +
  theme_Publication() +
  labs(x = "Year", y = "Mean Resistance", subtitle = "East Africa") + 
  scale_y_continuous(limits = c(0, 1), breaks = seq(0, 1, by = 0.2)) +
  scale_x_continuous(breaks = seq(min(eadf4$Year), max(eadf4$Year), by = 2)) +
  theme(axis.text.x = element_text(angle = 60, hjust = 1))



#North Africa plot

na<- df4%>%
  filter(region=="Northern Africa")

nadata2<- data2%>%
  filter(region=="Northern Africa")

namodel <- glm(MeanRes ~ Year, data = nadata2, family = quasibinomial, weights = no_isolate)

nanew_preds <- predict(namodel, newdata = data.frame(Year = seq(min(nadata2$Year), max(nadata2$Year), by = 1)), 
                       type = "response", se.fit = TRUE)


napred_df <- data.frame(
  Year = seq(min(nadata2$Year), max(nadata2$Year), by = 1),
  fit = nanew_preds$fit,
  se.fit = nanew_preds$se.fit
)



nafit1<-predict(namodel,type = "response", se.fit = T)


nadf1<-as.data.frame(nafit1)

nadf2<- cbind(nadata2, nadf1)

nadf3<- nadf2%>%
  mutate(lower = fit - 1.96 * se.fit)%>%
  mutate(upper = fit+ 1.96 * se.fit)

nadf4<- aggregate(MeanRes~doi+Year+region, data = nadf3, FUN = mean)


naplot <- ggplot() +
  geom_point(data = nadf4, aes(x = Year, y = MeanRes),
             shape = 21, color = "black", alpha = 0.4, size = 3) +
  geom_line(data = napred_df, aes(x = Year, y = fit), color = "blue", linewidth = 1) +
  geom_ribbon(data = napred_df, aes(x = Year, ymin = fit - 1.96*se.fit, ymax = fit + 1.96*se.fit),
              fill = "gray70", alpha = 0.3) +
  geom_boxplot(data = nadata2, aes(x = Year, y = MeanRes, group = Year),
               outlier.shape = NA, fill = "skyblue", color = "black", alpha = 0.2) +
  theme_Publication() +
  labs(x = "Year", y = "Mean Resistance", subtitle = "North Africa") + 
  scale_y_continuous(limits = c(0, 1), breaks = seq(0, 1, by = 0.2)) +
  scale_x_continuous(breaks = seq(min(nadf4$Year), max(nadf4$Year), by = 2)) +
  theme(axis.text.x = element_text(angle = 60, hjust = 1))


#West africa

wa<- df4%>%
  filter(region=="West Africa")

wadata2<- data2%>%
  filter(region=="West Africa")

wamodel <- glm(MeanRes ~ Year, data = wadata2, family = quasibinomial, weights = no_isolate)

wanew_preds <- predict(wamodel, newdata = data.frame(Year = seq(min(wadata2$Year), max(wadata2$Year), by = 1)), 
                       type = "response", se.fit = TRUE)


wapred_df <- data.frame(
  Year = seq(min(wadata2$Year), max(wadata2$Year), by = 1),
  fit = wanew_preds$fit,
  se.fit = wanew_preds$se.fit
)



wafit1<-predict(wamodel,type = "response", se.fit = T)


wadf1<-as.data.frame(wafit1)

wadf2<- cbind(wadata2, wadf1)

wadf3<- wadf2%>%
  mutate(lower = fit - 1.96 * se.fit)%>%
  mutate(upper = fit+ 1.96 * se.fit)

wadf4<- aggregate(MeanRes~doi+Year+region, data = wadf3, FUN = mean)


waplot <- ggplot() +
  geom_point(data = wadf4, aes(x = Year, y = MeanRes),
             shape = 21, color = "black", alpha = 0.4, size = 3) +
  geom_line(data = wapred_df, aes(x = Year, y = fit), color = "blue", linewidth = 1) +
  geom_ribbon(data = wapred_df, aes(x = Year, ymin = fit - 1.96*se.fit, ymax = fit + 1.96*se.fit),
              fill = "gray70", alpha = 0.3) +
  geom_boxplot(data = wadata2, aes(x = Year, y = MeanRes, group = Year),
               outlier.shape = NA, fill = "skyblue", color = "black", alpha = 0.2) +
  theme_Publication() +
  labs(x = "Year", y = "Mean Resistance", subtitle = "West Africa") + 
  scale_y_continuous(limits = c(0, 1), breaks = seq(0, 1, by = 0.2)) +
  scale_x_continuous(breaks = seq(min(wadf4$Year), max(wadf4$Year), by = 2)) +
  theme(axis.text.x = element_text(angle = 60, hjust = 1))






#south africa

sa<- df4%>%
  filter(region=="Southern Africa")

sadata2<- data2%>%
  filter(region=="Southern Africa")

samodel <- glm(MeanRes ~ Year, data = sadata2, family = quasibinomial, weights = no_isolate)

sanew_preds <- predict(samodel, newdata = data.frame(Year = seq(min(sadata2$Year), max(sadata2$Year), by = 1)), 
                       type = "response", se.fit = TRUE)


sapred_df <- data.frame(
  Year = seq(min(sadata2$Year), max(sadata2$Year), by = 1),
  fit = sanew_preds$fit,
  se.fit = sanew_preds$se.fit
)



safit1<-predict(samodel,type = "response", se.fit = T)


sadf1<-as.data.frame(safit1)

sadf2<- cbind(sadata2, sadf1)

sadf3<- sadf2%>%
  mutate(lower = fit - 1.96 * se.fit)%>%
  mutate(upper = fit+ 1.96 * se.fit)

sadf4<- aggregate(MeanRes~doi+Year+region, data = sadf3, FUN = mean)


saplot <- ggplot() +
  geom_point(data = sadf4, aes(x = Year, y = MeanRes),
             shape = 21, color = "black", alpha = 0.4, size = 3) +
  geom_line(data = sapred_df, aes(x = Year, y = fit), color = "blue", linewidth = 1) +
  geom_ribbon(data = sapred_df, aes(x = Year, ymin = fit - 1.96*se.fit, ymax = fit + 1.96*se.fit),
              fill = "gray70", alpha = 0.3) +
  geom_boxplot(data = sadata2, aes(x = Year, y = MeanRes, group = Year),
               outlier.shape = NA, fill = "skyblue", color = "black", alpha = 0.2) +
  theme_Publication() +
  labs(x = "Year", y = "Mean Resistance",
       subtitle = "Southern Africa") + 
  scale_y_continuous(limits = c(0, 1), breaks = seq(0, 1, by = 0.2)) +
  scale_x_continuous(breaks = seq(min(sadf4$Year), max(sadf4$Year), by = 2)) +
  theme(axis.text.x = element_text(angle = 60, hjust = 1))
saplot


ggarrange(eaplot , waplot, naplot , saplot,
                labels = c("(a)", "(b)", "(c)", "(d)"),
                common.legend = TRUE)


# yleft <- textGrob("Percent resistance", rot = 90, gp = gpar(fontsize = 20))
# bottom <- textGrob("Antimicrobial", gp = gpar(fontsize = 20))

#tiff("cp.tiff", width=2300, height=2000, res=300)


# ggsave(filename = "cp.tiff",
#        plot = cp,
#        device = "tiff",
#        width = 10,
#        height = 8,
#        units = "in",
#        dpi = 700,
#        compression = "lzw")

# p1 <- ggboxplot(df4, x = "Year", y = "MeanRes", fill = "MeanRes",
#                    xlab = "Year", ylab = "Percent resistance") +
# geom_boxplot(fill = "skyblue2") +
# geom_jitter(alpha = 0.4) +
# rotate_x_text(60) +
#  ggpubr::font("xlab", size = 17)+
#  ggpubr::font("ylab", size = 17)+
# ggpubr::font("xy.text", size = 17)+
# ggpubr::font("legend.title",size = 17)+
# ggpubr::font("legend.text", size = 17)
# 
# 
# # 
# p2<-p1 +
#   geom_smooth(aes(as.numeric(Year),
#           (MeanRes)),
#          method = "glm",se = T, colour = "maroon",lty=2,
#       method.args = list(family = "quasibinomial")) +
#   theme_Publication() 
    #geom_line(aes(y = lower), lty = 2) +
    #geom_line(aes(y = upper), lty = 2) +
  #facet_wrap(~region)

# p2<-p2 + scale_y_continuous(limits = c(0, 1), breaks = seq(0, 1, by = 0.2))+
#   rotate_x_text(60)
# 
# 
# p2


  


##Fisher exact test

df4.1<-aggregate(MeanRes~Year+region+fit, data = df3, FUN = mean)
#ftest<-fisher.test(table(df4.1$Year, df4.1$MeanRes))
#ftest <- fisher.test(table(df4$Year, df4$MeanRes), workspace=2e8)

# Using simulate.p.value to handle large tables
ftest <- fisher.test(table(df4.1$Year, df4.1$MeanRes), simulate.p.value=TRUE, B=1e5)

#ftest$p.value

#East Africa
ea<- df4.1%>%
  filter(region=="Eastern Africa")
#ea_ftest<-fisher.test(table(ea$Year, ea$MeanRes))
ea_ftest <- fisher.test(table(ea$Year, ea$MeanRes), simulate.p.value=TRUE, B=1e5)

#ea_ftest$p.value


#central africa
ca<- df4.1%>%
  filter(region=="Central Africa")
#ca_ftest<-fisher.test(table(ca$Year, ca$MeanRes))
ca_ftest <- fisher.test(table(ca$Year, ca$MeanRes), simulate.p.value=TRUE, B=1e5)
#ca_ftest$p.value

#Northern Africa
na<- df4.1%>%
  filter(region=="Northern Africa")
na_ftest<-fisher.test(table(na$Year, na$MeanRes), simulate.p.value=TRUE, B=1e5)
#na_ftest$p.value

#Southern Africa

sa<- df4.1%>%
  
  filter(region=="Southern Africa")

sa_ftest<-fisher.test(table(sa$Year, sa$MeanRes), simulate.p.value=TRUE, B=1e5)
#sa_ftest$p.value
#West Africa

wa<- df4.1%>%
  filter(region=="West Africa")

wa_ftest <- fisher.test(table(wa$Year, wa$MeanRes), simulate.p.value=TRUE, B=1e5)

#wa_ftest$p.value



df_overall<-aggregate(MeanRes~Year+region, data = df4, FUN = mean)

ea2<- aggregate(fit~Year, data = df3, FUN = mean)

#Number of studies included in temporal trend analysis
# df4.2<-aggregate((no_isolates_resistant/no_isolate)~doi+Year+region, data = AMRdf, FUN = mean) %>%
#   na.omit()
# 
# ea2<- df4.2%>%
#   filter(region=="Eastern Africa")
# 
# ea2%>%
#   count(doi)
# 
# wa2<- df4.2%>%
#   filter(region=="West Africa")
# 
# wa2%>%
#   count(doi)
# 
# na2<- df4.2%>%
#   filter(region=="Northern Africa")
# 
# na2%>%
#   count(doi)
# 
# sa2<- df4.2%>%
#   filter(region=="Southern Africa")
# 
# sa2%>%
#   count(doi)
# 
# ca2<- df4.2%>%
#   
#   filter(region=="Central Africa")
# 
# ca2%>%
#   count(doi)
# 



```


### Resistance of antibiotic compound aggregated by species at regional level


```{r Regional resistance patterns ,echo=FALSE, fig.height=15, fig.width=20, message=FALSE}

##The script is used in generating  Figure 6####



theme_Publication <- function(base_size=14, base_family="helvetica") {
  library(grid)
  library(ggthemes)
  (theme_foundation(base_size=base_size, base_family=base_family)
    + theme(plot.title = element_text(face = "bold",
                                      size = rel(1.2), hjust = 0.5),
            text = element_text(),
            panel.background = element_rect(colour = NA),
            plot.background = element_rect(colour = NA),
            panel.border = element_rect(colour = NA),
            axis.title = element_text(face = "bold",size = rel(1)),
            axis.title.y = element_text(angle=90,vjust =2),
            axis.title.x = element_text(vjust = -0.2),
            axis.text = element_text(), 
            axis.line = element_line(colour="black"),
            axis.ticks = element_line(),
            panel.grid.major = element_line(colour="#f0f0f0"),
            panel.grid.minor = element_blank(),
            legend.key = element_rect(colour = NA),
            legend.position = "bottom",
            legend.direction = "horizontal",
            legend.key.size= unit(0.2, "cm"),
            legend.margin = unit(0, "cm"),
            legend.title = element_text(face="italic"),
            plot.margin=unit(c(10,5,5,5),"mm"),
            strip.background=element_rect(colour="#f0f0f0",fill="#f0f0f0"),
            strip.text = element_text(face="bold")
    ))
  
}

scale_fill_Publication <- function(...){
  library(scales)
  discrete_scale("fill","Publication",manual_pal(values = c("#386cb0","#fdb462","#7fc97f","#ef3b2c","#662506","#a6cee3","#fb9a99","#984ea3","#ffff33")), ...)
  
}

scale_colour_Publication <- function(...){
  library(scales)
  discrete_scale("colour","Publication",manual_pal(values = c("#386cb0","#fdb462","#7fc97f","#ef3b2c","#662506","#a6cee3","#fb9a99","#984ea3","#ffff33")), ...)
  
}



AMR_clean <- read.csv("AMR_clean.csv")

AMR_clean %>%
  count(no_isolates_susceptible)%>%
  View()

colnames(AMR_clean)


AMR_clean<- AMR_clean %>%
  dplyr::select(doi,country,region, iso_3, y_coordinate,x_coordinate,sampling_start_year,
                sampling_end_year, species, pathogen,sal_prevalence, no_sample,
                antimicrobial,antimicrobial_compound,antibiotic_class,
                who_classification, no_isolate,no_isolates_resistant, 
                no_isolates_intermediate,no_isolates_susceptible,mdr_percentage)                                      


AMR_clean<- AMR_clean %>%
  dplyr::mutate(no_isolates_susceptible=no_isolate-no_isolates_resistant)

AMR_clean<- AMR_clean %>% 
  dplyr::select(-no_isolates_intermediate)


##Pooled prevalence for salmonella by antibiotic compounds- bargraphs
#aggregate all resistant isolates and all NIsolates by speciesag, compound and region
SalRes = aggregate(no_isolates_resistant ~ antimicrobial_compound + species + region, data = AMR_clean, FUN = sum)
SalAll = aggregate(no_isolate ~ antimicrobial_compound + species + region, data = AMR_clean, FUN = sum)

#and divide ResIso/NIsolates to return true mean
SalMean = round((SalRes$no_isolates_resistant /SalAll$no_isolate)*100, digits = 0)
SalMeandf = as.data.frame(cbind(SalRes$antimicrobial_compound, SalRes$species, SalRes$region, SalMean, SalAll$no_isolate))
colnames(SalMeandf) = c("Compound","Species","region","Mean","NIsolates")
SalMeandf$Mean = as.numeric(as.character(SalMeandf$Mean))
SalMeandf$NIsolates = as.numeric(as.character(SalMeandf$NIsolates))

#restrict analysis to bacteria-drug pairings where NIsolates > =10
SalMeandf = SalMeandf[which(SalMeandf$NIsolates >= 10),]

#hist(SalMeandf$Mean, main = "Distribution of Mean Prevalence", xlab = "Mean Prevalence")


# Compute the 95% CI of proportion where x = p_hat and y = n two tailed z = 1.96
CI.function <- function(x,y) {
  x + c(-1.96,1.96)*sqrt(x*(1-x)/y)}

#95% CI
CIsal = as.data.frame(t(mapply(CI.function, SalMeandf$Mean/100,  SalMeandf$NIsolates)))
SalMeandf  = cbind(SalMeandf, round(CIsal*100, digits = 0))
colnames(SalMeandf) = c("Compound","Species","Region","Mean","NIsolates","CILow","CIHigh")
SalMeandf$CILow[SalMeandf$CILow < 0] = 0
SalMeandf$CIHigh[SalMeandf$CIHigh >100] = 100

col_index <- 4  # Assuming you want to check the second column

# Select rows where the specified column has a value other than zero
SalMeandf <- SalMeandf[SalMeandf[, col_index] != 0, ]

#East African Bar plots
sal.ea<-SalMeandf %>%
  dplyr::filter(Compound %in% c('ERY', 'STR', 'TET', 'AMP', 'NIT', 'KAN', 
                                'NAL', 'SOX', 'AMC' 
                                #'CHL', 'COT', 'CIP',
                                #'CFL', 'GEN', 'NEO', 'TMP'
  ), Region == "Eastern Africa")

sal.ea$Compound <- reorder(sal.ea$Compound, -sal.ea$Mean)

sal.ea.plot <- ggbarplot(sal.ea, "Compound", "Mean", 
                         fill = "Species", position = position_dodge(0.7),
                         subtitle = "Eastern Africa",# Cattle, n = 3,523, 
                         # Chicken, n = 5,906, Pigs = n = 3,252", 
                         xlab = FALSE, ylab = FALSE,
                         legend.title = "Species",
                         font.subtitle = c(12))+
  rotate_x_text(90)+
  geom_linerange(aes(group = Species, ymax = CIHigh, ymin = CILow),
                 position = position_dodge(width = 0.7))+
  font("xy.text", size = 19)+
  font("legend.title",size = 19)+
  font("legend.text", size = 19)+
  theme_Publication()+
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank())


sum_by_speciesEA <- sal.ea %>%
  group_by(Species) %>%
  summarize(total_isolates = sum(NIsolates))


sal.ea.plot <- ggpar(sal.ea.plot, ylim = c(0, 100))


#West African Bar plots
sal.wa<-SalMeandf %>%
  dplyr::filter(Compound %in% c('ERY', 'AMX', 'AMP', 'AMC', 'COT', 'CTX', 
                                'SMX' #'TET', 'MIN', 'STR', 'NAL',
                                #'GEN', 'CAZ', 'CIP', 'CHL'
  ), Region == "West Africa")


sal.wa$Compound <- reorder(sal.wa$Compound, -sal.wa$Mean)





species <- c("Cattle", "Chicken", "Environment", "Pigs")
compounds <- c("AMP", "AMX", "ERY", "AMC", "COT", "CTX", "SMX")

# Create an empty data frame
data1 <- data.frame(Compound = character(),
                    Species = character(),
                    Region = character(),
                    Mean = numeric(),
                    NIsolates = numeric(),
                    CILow = numeric(),
                    CIHigh = numeric(),
                    stringsAsFactors = FALSE)

# Populate the data frame with all combinations of species and compounds
for (sp in species) {
  for (cp in compounds) {
    data1 <- rbind(data1, data.frame(Compound = cp, Species = sp, Region = "West Africa", Mean = 0, NIsolates = 0, CILow = 0, CIHigh = 0))
  }
}




sal.wa<-rbind(sal.wa, data1)






sum_by_speciesWA <- sal.wa %>%
  group_by(Species) %>%
  summarize(total_isolates = sum(NIsolates)) 

sal.wa.plot <- ggbarplot(sal.wa, "Compound", "Mean", 
                         fill = "Species", position = position_dodge(0.7),
                         subtitle = "West Africa", #Cattle n = 1,643, Chicken n = 19,595, 
                         # Environment n = 1,395, Pig n = 2,676, Sheep n = 32",
                         xlab = FALSE, ylab = FALSE,
                         legend.title = "Species",
                         font.subtitle = c(12))+
  rotate_x_text(90)+
  geom_linerange(aes(group = Species, ymax = CIHigh, ymin = CILow),
                 position = position_dodge(width = 0.7))+
  font("xy.text", size = 19)+
  font("legend.title",size = 19)+
  font("legend.text", size = 19)+
  theme_Publication()+
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank())


sal.wa.plot <- ggpar(sal.wa.plot, ylim = c(0, 100))


#North African Bar plots
sal.na<-SalMeandf %>%
  dplyr::filter(Compound %in% c( 'AMX', 'AMP', 'AMC', 'COT', 'CTX', 
                                 'SMX', 'TET', 'TMP' 
                                 #'MIN', 'STR', 'NAL',
                                 #'GEN', 'CIP', 'CHL'
  ), Region == "Northern Africa")




additional_data <- data.frame(
  Compound = c("SMX", "AMX", "CTX"),
  Species = c("Turkey", "Turkey",  "Cattle"),
  Mean = c(0.01, 0.01,  0.01))


additional_data <- additional_data %>%
  mutate(Region = "Northern Africa",
         NIsolates = 78,
         CILow = 0,
         CIHigh = 0)

# Combine the original data with the additional data
sal.na <- rbind(sal.na, additional_data)

sal.na%>%
  mutate(Mean1=Mean)

sal.na$Compound <- reorder(sal.na$Compound, -sal.na$Mean)

sum_by_speciesNA <- sal.na %>%
  group_by(Species) %>%
  summarize(total_isolates = sum(NIsolates)) 

sal.na.plot <- ggbarplot(sal.na, "Compound", "Mean", 
                         fill = "Species", position = position_dodge(0.7),
                         subtitle = "Northern Africa",# Cattle n = 1,438,
                         # Chicken n = 7,154, Turkey n = 744",
                         xlab = FALSE, ylab = FALSE,
                         legend.title = "Species",
                         font.subtitle = c(12))+
  rotate_x_text(90)+
  geom_linerange(aes(group = Species, ymax = CIHigh, ymin = CILow),
                 position = position_dodge(width = 0.7))+
  font("xy.text", size = 19)+
  font("legend.title",size = 19)+
  font("legend.text", size = 19)+
  theme_Publication()+
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank())





sal.na.plot <- ggpar(sal.na.plot, ylim = c(0, 100))

#South African Bar plots
sal.sa<-SalMeandf %>%
  dplyr::filter(Compound %in% c('SOX', 'ERY', 'AMX', 'TET', 'STR', 'CTX', 
                                'CFX', 'AMP', 'AMC', 'COT' #'CHL', 'CFL',
                                #'NOR', 'KAN', 'CIP', 'NAL'
  ), Region == "Southern Africa")

sal.sa$Compound <- reorder(sal.sa$Compound, -sal.sa$Mean)



# Define the species and compounds
species <- c("Cattle", "Chicken", "Goats", "Pigs", "Sheep")
compounds <- c("SOX", "ERY", "AMX", "TET", "STR", "CTX", "CFX", "AMP", "AMC", "COT")

# Create an empty data frame
data <- data.frame(Compound = character(),
                   Species = character(),
                   Region = character(),
                   Mean = numeric(),
                   NIsolates = numeric(),
                   CILow = numeric(),
                   CIHigh = numeric(),
                   stringsAsFactors = FALSE)

# Populate the data frame with all combinations of species and compounds
for (sp in species) {
  for (cp in compounds) {
    data <- rbind(data, data.frame(Compound = cp, Species = sp, Region = "Southern Africa", Mean = 0, NIsolates = 0, CILow = 0, CIHigh = 0))
  }
}

# Print the data frame


sal.sa<-rbind(sal.sa, data) 





sum_by_speciesSA <- sal.sa %>%
  group_by(Species) %>%
  summarize(total_isolates = sum(NIsolates))


sal.sa.plot <- ggbarplot(sal.sa, "Compound", "Mean", 
                         fill = "Species", position = position_dodge(0.7),
                         subtitle = "Southern Africa",
                         #Cattle n = 2,239, Chicken n = 7,639,
                         # Goats n = 612, Pigs n = 1,068, Sheep n = 264",
                         #                         xlab = FALSE, ylab = FALSE,
                         legend.title = "Species",
                         legend.position = "top",
                         font.subtitle = c(12))+
  rotate_x_text(90)+
  geom_linerange(aes(group = Species, ymax = CIHigh, ymin = CILow),
                 position = position_dodge(width = 0.7))+
  font("xy.text", size = 19)+
  font("legend.title",size = 19)+
  font("legend.text", size = 19)+
  theme_Publication()+
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank())


sal.sa.plot <- ggpar(sal.sa.plot, ylim = c(0, 100))


p1<-  ggarrange(sal.ea.plot , sal.wa.plot, sal.na.plot , sal.sa.plot,
                labels = c("(a)", "(b)", "(c)", "(d)"))

yleft <- textGrob("Percent resistance", rot = 90, gp = gpar(fontsize = 20))
bottom <- textGrob("Antimicrobial", gp = gpar(fontsize = 20))


region_plot <- (sal.ea.plot | sal.wa.plot)/ (sal.na.plot | sal.sa.plot)+
  plot_annotation(tag_levels = "a",
                  tag_prefix = "(",
                  tag_suffix = ")")&
  theme(plot.tag = element_text(face = "bold"),
        legend.position = "top")


plot1 <- patchwork::patchworkGrob(region_plot)
#tiff("p1.tiff", width=3500, height=2000, res=300)
p1 <- grid.arrange(plot1, ncol = 1, nrow = 1,left = yleft, bottom = bottom)
p1

# 
# ggsave(filename = "p1.tiff",
#        plot = p1,
#        device = "tiff",
#        width = 10,
#        height = 8,
#        units = "in",
#        dpi = 700,
#        compression = "lzw")



#dev.off()


  
```

### Median resistance of antibiotic class aggregated by species 



```{r Antibiotic class resistance,echo=FALSE, fig.height=15, fig.width=20, message=FALSE}


theme_Publication <- function(base_size=14, base_family="helvetica") {
  library(grid)
  library(ggthemes)
  (theme_foundation(base_size=base_size, base_family=base_family)
    + theme(plot.title = element_text(face = "bold",
                                      size = rel(1.2), hjust = 0.5),
            text = element_text(),
            panel.background = element_rect(colour = NA),
            plot.background = element_rect(colour = NA),
            panel.border = element_rect(colour = NA),
            axis.title = element_text(face = "bold", size = rel(1)),
            axis.title.y = element_text(angle=90, vjust = 2),
            axis.title.x = element_text(vjust = -0.2),
            axis.text = element_text(), 
            axis.line = element_line(colour="black"),
            axis.ticks = element_line(),
            panel.grid.major = element_line(colour="#f0f0f0"),
            panel.grid.minor = element_blank(),
            legend.key = element_rect(colour = NA),
            legend.position = "",
            legend.direction = "horizontal",
            legend.key.size = unit(0.2, "cm"),
            legend.margin = unit(0, "cm"),
            legend.title = element_blank(),  # Remove legend title
            legend.text = element_blank(),   # Optionally, remove legend text
            plot.margin = unit(c(10,5,5,5), "mm"),
            strip.background = element_rect(colour="#f0f0f0", fill="#f0f0f0"),
            strip.text = element_text(face="bold")
    ))
}

scale_fill_Publication <- function(...) {
  library(scales)
  discrete_scale("fill", "Publication", manual_pal(values = c("#386cb0", "#fdb462", "#7fc97f", "#ef3b2c", "#662506", "#a6cee3", "#fb9a99", "#984ea3", "#ffff33")), ...)
}

scale_colour_Publication <- function(...) {
  library(scales)
  discrete_scale("colour", "Publication", manual_pal(values = c("#386cb0", "#fdb462", "#7fc97f", "#ef3b2c", "#662506", "#a6cee3", "#fb9a99", "#984ea3", "#ffff33")), ...)
}




AMR_clean <- read.csv("AMR_clean.csv")



colnames(AMR_clean)


AMR_clean<- AMR_clean %>%
  dplyr::select(doi,country,region, iso_3, y_coordinate,x_coordinate,sampling_start_year,
                sampling_end_year, species, pathogen,sal_prevalence,
                antimicrobial_compound,antibiotic_class,
                who_classification, no_isolate,no_isolates_resistant, 
                no_isolates_intermediate,no_isolates_susceptible,mdr_percentage)                                      


AMR_clean<- AMR_clean %>%
  dplyr::mutate(no_isolates_susceptible=no_isolate-no_isolates_resistant)


#marge all cephalosporin groups to one
AMR_clean$antibiotic_class[AMR_clean$antibiotic_class=="3rd generation Cephalosporin"] <- "Cephalosporins"
AMR_clean$antibiotic_class[AMR_clean$antibiotic_class=="1st generation Cephalosporin"] <- "Cephalosporins"
AMR_clean$antibiotic_class[AMR_clean$antibiotic_class=="2nd generation Cephalosporin"] <- "Cephalosporins"
AMR_clean$antibiotic_class[AMR_clean$antibiotic_class=="4th generation Cephalosporin"] <- "Cephalosporins"
#Merge amphenicol groups to flouroquinolones


AMR_clean$antibiotic_class[AMR_clean$antibiotic_class=="Amphenicols"] <- "Fluoroquinolones"

AMR_clean<- AMR_clean %>% 
  dplyr::select(-no_isolates_intermediate)

unique(AMR_clean$antibiotic_class)
AMR_tet<- AMR_clean %>%
  filter(antibiotic_class=="Tetracycline")

unique(AMR_tet$antibiotic_class)
AMR_pen<- AMR_clean %>%
  filter(antibiotic_class=="Penicillin " )
unique(AMR_pen$antibiotic_class)
AMR_ceph<- AMR_clean %>%
  filter(antibiotic_class=="Cephalosporins")

unique(AMR_ceph$antibiotic_class)
AMR_amino<- AMR_clean %>%
  filter(antibiotic_class=="Aminoglycosides")

unique(AMR_amino$antibiotic_class)
AMR_floro<- AMR_clean %>%
  filter(antibiotic_class=="Fluoroquinolones")

unique(AMR_floro$antibiotic_class)
AMR_sulf<- AMR_clean %>%
  filter(antibiotic_class=="Sulfonamides")

unique(AMR_sulf$antibiotic_class)




#AMR resistance levels for tetracycline by species

##Pooled prevalence for salmonella by antibiotic compounds- bargraphs
#aggregate all resistant isolates and all NIsolates by speciesag, compound and region
tetSalRes = aggregate(no_isolates_resistant ~  antimicrobial_compound+species+country , data = AMR_tet, FUN = sum)
tetSalAll = aggregate(no_isolate ~  antimicrobial_compound+species+country , data = AMR_tet, FUN = sum)

#and divide ResIso/NIsolates to return true mean
tetSalMean = round((tetSalRes$no_isolates_resistant /tetSalAll$no_isolate)*100, digits = 0)
tetSalMeandf = as.data.frame(cbind(tetSalRes$antimicrobial_compound,  tetSalRes$species, tetSalMean, tetSalAll$no_isolate, tetSalRes$country))
colnames(tetSalMeandf) = c("antimicrobial_compound", "Species","Mean","NIsolates", "country")
tetSalMeandf$Mean = as.numeric(as.character(tetSalMeandf$Mean))
tetSalMeandf$NIsolates = as.numeric(as.character(tetSalMeandf$NIsolates))


tetSalMeandf$Mean <- as.numeric(as.character(tetSalMeandf$Mean))


tetdf1 <- tetSalMeandf %>%
  group_by(Species) %>%
  select(
         "country",
         "antimicrobial_compound",
         "Mean",
         "NIsolates")


tetdf2 <-aggregate(Mean~Species+antimicrobial_compound, data = tetdf1, FUN=mean)


#changing percentage resistance into numeric class and rounding off  
tetdf2$Mean <- as.numeric(as.character(tetdf2$Mean))

tetdf2$Mean <- round(tetdf2$Mean, digits = 0)

tetdf2<- tetdf2[which(tetdf2$Mean>= 1),]

#tiff("cp.species_plot.tiff", width=2300, height=2000, res=300)
##species barplot
tetspecies_plot<-ggplot(tetdf2, aes(x = Species, y = Mean, fill = Species))+ 
  geom_boxplot(
    width = .15, 
    outlier.shape = NA
  ) +
  
  scale_fill_brewer(palette = "Paired") +
  theme(legend.position = "top")+
  coord_cartesian(xlim = c(1.2, NA), clip = "off")

#theme_pubr
tetpp1<- tetspecies_plot+
  theme_pubr(
    base_size = 17,
    base_family = "",
    border = FALSE,
    margin = TRUE,
    legend = c("top"),
    x.text.angle = 0
  )

#labelling the plot
tet<- tetpp1 + 
  labs(
    x = "Host", 
    y = "Percent resistance", 
    fill = "Host", 
    color = "Host", 
    subtitle = "Tetracycline"
  ) +
  scale_color_discrete(name = "Host") +
  scale_x_discrete(
    name = "Host", 
    limits = c("Cattle", "Chicken", "Goats", "Pigs", "Sheep", "Turkey", "Environment")
  ) +
  theme(
    axis.text.x = element_text(angle = 60, hjust = 1),
    legend.position = "none"
  ) +
  theme_Publication()

#call the plot
tet<-tet+ scale_y_continuous(limits = c(0, 100))+
  rotate_x_text(60)

tet

#AMR resistance levels for penicillin by species

##Pooled prevalence for salmonella by antibiotic compounds- bargraphs
#aggregate all resistant isolates and all NIsolates by speciesag, compound and region
penSalRes = aggregate(no_isolates_resistant ~  antimicrobial_compound+species+country , data = AMR_pen, FUN = sum)
penSalAll = aggregate(no_isolate ~  antimicrobial_compound+species+country , data = AMR_pen, FUN = sum)
  
#and divide ResIso/NIsolates to return true mean
penSalMean = round((penSalRes$no_isolates_resistant /penSalAll$no_isolate)*100, digits = 0)
penSalMeandf = as.data.frame(cbind(penSalRes$antimicrobial_compound,  penSalRes$species, penSalMean, penSalAll$no_isolate, penSalRes$country))
colnames(penSalMeandf) = c("antimicrobial_compound", "Species","Mean","NIsolates", "country")
penSalMeandf$Mean = as.numeric(as.character(penSalMeandf$Mean))
penSalMeandf$NIsolates = as.numeric(as.character(penSalMeandf$NIsolates))

penSalMeandf$Mean <- as.numeric(as.character(penSalMeandf$Mean))


#group by species
pendf1 <- penSalMeandf %>%
  group_by(Species) %>%
  select(
    "country",
    "antimicrobial_compound",
    "Mean",
    "NIsolates")


##Aggregate mean resistance levels for penicillin by species
pendf2 <-aggregate(Mean~Species+antimicrobial_compound, data = pendf1, FUN=mean)

#changing percentage resistance into numeric class and rounding off 

pendf2$Mean <- as.numeric(as.character(pendf2$Mean))

pendf2$Mean <- round(pendf2$Mean, digits = 0)

pendf2<- pendf2[which(pendf2$Mean>= 1),]

##species barplot
penspecies_plot<-ggplot(pendf2, aes(x = Species, y = Mean, fill = Species))+ 
  geom_boxplot(
    width = .15, 
    outlier.shape = NA
  ) +
  
  scale_fill_brewer(palette = "Paired") +
  theme(legend.position = "top")+
  coord_cartesian(xlim = c(1.2, NA), clip = "off")

#theme_pubr
penpp1<- penspecies_plot+
  theme_pubr(
    base_size = 17,
    base_family = "",
    border = FALSE,
    margin = TRUE,
    legend = c("top"),
    x.text.angle = 0
  )

#labelling the plot
pen<- penpp1 + 
  labs(
    x = "Host", 
    y = "Percent resistance", 
    fill = "Host", 
    color = "Host", 
    subtitle = "Penicillin"
  ) +
  scale_color_discrete(name = "Host") +
  scale_x_discrete(
    name = "Host", 
    limits = c("Cattle", "Chicken", "Goats", "Pigs", "Sheep", "Turkey", "Environment")
  ) +
  theme(
    axis.text.x = element_text(angle = 60, hjust = 1),
    legend.position = "none"
  ) +
  theme_Publication()

#call the plot

pen<-pen+ scale_y_continuous(limits = c(0, 100))+
  rotate_x_text(60)

pen

#AMR resistance levels for cephalosporins by species

##Pooled prevalence for salmonella by antibiotic compounds- bargraphs
#aggregate all resistant isolates and all NIsolates by speciesag, compound and region
cephSalRes = aggregate(no_isolates_resistant ~  antimicrobial_compound+species+country , data = AMR_ceph, FUN = sum)
cephSalAll = aggregate(no_isolate ~  antimicrobial_compound+species+country , data = AMR_ceph, FUN = sum)

#and divide ResIso/NIsolates to return true mean
cephSalMean = round((cephSalRes$no_isolates_resistant /cephSalAll$no_isolate)*100, digits = 0)
cephSalMeandf = as.data.frame(cbind(cephSalRes$antimicrobial_compound,  cephSalRes$species, cephSalMean, cephSalAll$no_isolate, cephSalRes$country))
colnames(cephSalMeandf) = c("antimicrobial_compound", "Species","Mean","NIsolates", "country")
cephSalMeandf$Mean = as.numeric(as.character(cephSalMeandf$Mean))
cephSalMeandf$NIsolates = as.numeric(as.character(cephSalMeandf$NIsolates))
  
cephSalMeandf$Mean <- as.numeric(as.character(cephSalMeandf$Mean))


#group by species
cephdf1 <- cephSalMeandf %>%
  group_by(Species) %>%
  select(
    "country",
    "antimicrobial_compound",
    "Mean",
    "NIsolates")


##Aggregate mean resistance levels for cephalosporins by species
cephdf2 <-aggregate(Mean~Species+antimicrobial_compound, data = cephdf1, FUN=mean)

#changing percentage resistance into numeric class and rounding off

cephdf2$Mean <- as.numeric(as.character(cephdf2$Mean))

cephdf2$Mean <- round(cephdf2$Mean, digits = 0)

cephdf2<- cephdf2[which(cephdf2$Mean>= 1),]

##species barplot
cephspecies_plot<-ggplot(cephdf2, aes(x = Species, y = Mean, fill = Species))+ 
  geom_boxplot(
    width = .15, 
    outlier.shape = NA
  ) +
  
  scale_fill_brewer(palette = "Paired") +
  theme(legend.position = "top")+
  coord_cartesian(xlim = c(1.2, NA), clip = "off")

#theme_pubr
cephpp1<- cephspecies_plot+
  theme_pubr(
    base_size = 17,
    base_family = "",
    border = FALSE,
    margin = TRUE,
    legend = c("top"),
    x.text.angle = 0
  )
  
#labelling the plot
ceph<- cephpp1 + 
  labs(
    x = "Host", 
    y = "Percent resistance", 
    fill = "Host", 
    color = "Host", 
    subtitle = "Cephalosporins"
  ) +
  scale_color_discrete(name = "Host") +
  scale_x_discrete(
    name = "Host", 
    limits = c("Cattle", "Chicken", "Goats", "Pigs", "Sheep", "Turkey", "Environment")
  ) +
  theme(
    axis.text.x = element_text(angle = 60, hjust = 1),
    legend.position = "none"
  ) +
  theme_Publication()

#call the plot

ceph<-ceph+ scale_y_continuous(limits = c(0, 100))+
  rotate_x_text(60)

ceph


#AMR resistance levels for aminoglycosides by species

##Pooled prevalence for salmonella by antibiotic compounds- bargraphs
#aggregate all resistant isolates and all NIsolates by speciesag, compound and region
aminoSalRes = aggregate(no_isolates_resistant ~  antimicrobial_compound+species+country , data = AMR_amino, FUN = sum)
aminoSalAll = aggregate(no_isolate ~  antimicrobial_compound+species+country , data = AMR_amino, FUN = sum)

#and divide ResIso/NIsolates to return true mean
aminoSalMean = round((aminoSalRes$no_isolates_resistant /aminoSalAll$no_isolate)*100, digits = 0)
aminoSalMeandf = as.data.frame(cbind(aminoSalRes$antimicrobial_compound,  aminoSalRes$species, aminoSalMean, aminoSalAll$no_isolate, aminoSalRes$country))
colnames(aminoSalMeandf) = c("antimicrobial_compound", "Species","Mean","NIsolates", "country")
aminoSalMeandf$Mean = as.numeric(as.character(aminoSalMeandf$Mean))
aminoSalMeandf$NIsolates = as.numeric(as.character(aminoSalMeandf$NIsolates))

aminoSalMeandf$Mean <- as.numeric(as.character(aminoSalMeandf$Mean))


#group by species
aminodf1 <- aminoSalMeandf %>%
  group_by(Species) %>%
  select(
    "country",
    "antimicrobial_compound",
    "Mean",
    "NIsolates")


##Aggregate mean resistance levels for aminoglycosides by species
aminodf2 <-aggregate(Mean~Species+antimicrobial_compound, data = aminodf1, FUN=mean)

#changing percentage resistance into numeric class and rounding off

aminodf2$Mean <- as.numeric(as.character(aminodf2$Mean))

aminodf2$Mean <- round(aminodf2$Mean, digits = 0)

aminodf2<- aminodf2[which(aminodf2$Mean>= 1),]

##species barplot
aminospecies_plot<-ggplot(aminodf2, aes(x = Species, y = Mean, fill = Species))+ 
  geom_boxplot(
    width = .15, 
    outlier.shape = NA
  ) +
  
  scale_fill_brewer(palette = "Paired") +
  theme(legend.position = "top")+
  coord_cartesian(xlim = c(1.2, NA), clip = "off")

#theme_pubr
aminopp1<- aminospecies_plot+
  theme_pubr(
    base_size = 17,
    base_family = "",
    border = FALSE,
    margin = TRUE,
    legend = c("top"),
    x.text.angle = 0
  )

#labelling the plot

amino<- aminopp1 + 
  labs(
    x = "Host", 
    y = "Percent resistance", 
    fill = "Host", 
    color = "Host", 
    subtitle = "Aminoglycosides"
  ) +
  scale_color_discrete(name = "Host") +
  scale_x_discrete(
    name = "Host", 
    limits = c("Cattle", "Chicken", "Goats", "Pigs", "Sheep", "Turkey", "Environment")
  ) +
  theme(
    axis.text.x = element_text(angle = 60, hjust = 1),
    legend.position = "none"
  ) +
  theme_Publication()

#call the plot

amino<-amino+ scale_y_continuous(limits = c(0, 100))+
  rotate_x_text(60)

amino


#AMR resistance levels for fluoroquinolones by species

##Pooled prevalence for salmonella by antibiotic compounds- bargraphs
#aggregate all resistant isolates and all NIsolates by speciesag, compound and region
floroSalRes = aggregate(no_isolates_resistant ~  antimicrobial_compound+species+country , data = AMR_floro, FUN = sum)
floroSalAll = aggregate(no_isolate ~  antimicrobial_compound+species+country , data = AMR_floro, FUN = sum)

#and divide ResIso/NIsolates to return true mean
floroSalMean = round((floroSalRes$no_isolates_resistant /floroSalAll$no_isolate)*100, digits = 0)
floroSalMeandf = as.data.frame(cbind(floroSalRes$antimicrobial_compound,  floroSalRes$species, floroSalMean, floroSalAll$no_isolate, floroSalRes$country))
colnames(floroSalMeandf) = c("antimicrobial_compound", "Species","Mean","NIsolates", "country")
floroSalMeandf$Mean = as.numeric(as.character(floroSalMeandf$Mean))
floroSalMeandf$NIsolates = as.numeric(as.character(floroSalMeandf$NIsolates))

floroSalMeandf$Mean <- as.numeric(as.character(floroSalMeandf$Mean))


#group by species
florodf1 <- floroSalMeandf %>%
  group_by(Species) %>%
  select(
    "country",
    "antimicrobial_compound",
    "Mean",
    "NIsolates")


##Aggregate mean resistance levels for fluoroquinolones by species
florodf2 <-aggregate(Mean~Species+antimicrobial_compound, data = florodf1, FUN=mean)

#changing percentage resistance into numeric class and rounding off

florodf2$Mean <- as.numeric(as.character(florodf2$Mean))

florodf2$Mean <- round(florodf2$Mean, digits = 0)

florodf2<- florodf2[which(florodf2$Mean>= 1),]

##species barplot
florospecies_plot<-ggplot(florodf2, aes(x = Species, y = Mean, fill = Species))+ 
  geom_boxplot(
    width = .15, 
    outlier.shape = NA
  ) +
  
  scale_fill_brewer(palette = "Paired") +
  theme(legend.position = "top")+
  coord_cartesian(xlim = c(1.2, NA), clip = "off")

#theme_pubr
floropp1<- florospecies_plot+
  theme_pubr(
    base_size = 17,
    base_family = "",
    border = FALSE,
    margin = TRUE,
    legend = c("top"),
    x.text.angle = 0
  )

#labelling the plot

floro<- floropp1 + 
  labs(
    x = "Host", 
    y = "Percent resistance", 
    fill = "Host", 
    color = "Host", 
    subtitle = "Fluoroquinolones"
  ) +
  scale_color_discrete(name = "Host") +
  scale_x_discrete(
    name = "Host", 
    limits = c("Cattle", "Chicken", "Goats", "Pigs", "Sheep", "Turkey", "Environment")
  ) +
  theme(
    axis.text.x = element_text(angle = 60, hjust = 1),
    legend.position = "none"
  ) +
  theme_Publication()

#call the plot

floro<-floro+ scale_y_continuous(limits = c(0, 100))+
  rotate_x_text(60)

floro

#AMR resistance levels for sulfonamides by species

##Pooled prevalence for salmonella by antibiotic compounds- bargraphs
#aggregate all resistant isolates and all NIsolates by speciesag, compound and region
sulfSalRes = aggregate(no_isolates_resistant ~  antimicrobial_compound+species+country , data = AMR_sulf, FUN = sum)
sulfSalAll = aggregate(no_isolate ~  antimicrobial_compound+species+country , data = AMR_sulf, FUN = sum)

#and divide ResIso/NIsolates to return true mean
sulfSalMean = round((sulfSalRes$no_isolates_resistant /sulfSalAll$no_isolate)*100, digits = 0)
sulfSalMeandf = as.data.frame(cbind(sulfSalRes$antimicrobial_compound,  sulfSalRes$species, sulfSalMean, sulfSalAll$no_isolate, sulfSalRes$country))
colnames(sulfSalMeandf) = c("antimicrobial_compound", "Species","Mean","NIsolates", "country")
sulfSalMeandf$Mean = as.numeric(as.character(sulfSalMeandf$Mean))
sulfSalMeandf$NIsolates = as.numeric(as.character(sulfSalMeandf$NIsolates))

sulfSalMeandf$Mean <- as.numeric(as.character(sulfSalMeandf$Mean))
  
#group by species
sulfdf1 <- sulfSalMeandf %>%
  group_by(Species) %>%
  select(
    "country",
    "antimicrobial_compound",
    "Mean",
    "NIsolates")


##Aggregate mean resistance levels for sulfonamides by species
sulfdf2 <-aggregate(Mean~Species+antimicrobial_compound, data = sulfdf1, FUN=mean)


#changing percentage resistance into numeric class and rounding off

sulfdf2$Mean <- as.numeric(as.character(sulfdf2$Mean))

sulfdf2$Mean <- round(sulfdf2$Mean, digits = 0)

sulfdf2<- sulfdf2[which(sulfdf2$Mean>= 1),]

##species barplot
sulfspecies_plot<-ggplot(sulfdf2, aes(x = Species, y = Mean, fill = Species))+ 
  geom_boxplot(
    width = .15, 
    outlier.shape = NA
  ) +
  
  scale_fill_brewer(palette = "Paired") +
  theme(legend.position = "top")+
  coord_cartesian(xlim = c(1.2, NA), clip = "off")

#theme_pubr
sulfpp1<- sulfspecies_plot+
  theme_pubr(
    base_size = 17,
    base_family = "",
    border = FALSE,
    margin = TRUE,
    legend = c("top"),
    x.text.angle = 0
  )

#labelling the plot

sulf<- sulfpp1 + 
  labs(
    x = "Host", 
    y = "Percent resistance", 
    fill = "Host", 
    color = "Host", 
    subtitle = "Sulfonamides"
  ) +
  scale_color_discrete(name = "Host") +
  scale_x_discrete(
    name = "Host", 
    limits = c("Cattle", "Chicken", "Goats", "Pigs", "Sheep", "Turkey", "Environment")
  ) +
  theme(
    axis.text.x = element_text(angle = 60, hjust = 1),
    legend.position = "none"
  ) +
  theme_Publication()

#call the plot

sulf<-sulf+ scale_y_continuous(limits = c(0, 100))+
  rotate_x_text(60)





cp.species_plot <- (tet | pen)/ (sulf | ceph)+
  plot_annotation(tag_levels = "a",
                  tag_prefix = "(",
                  tag_suffix = ")")&
  theme(plot.tag = element_text(face = "bold"))
print(cp.species_plot)

```


